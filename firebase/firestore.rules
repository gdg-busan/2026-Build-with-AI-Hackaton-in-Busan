rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Event config - readable by authenticated users, writable by admins only
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin';

      // Teams - readable by authenticated, writable by admins
      match /teams/{teamId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.token.role == 'admin';

        // Team cheers - enforce userId matches auth
        match /cheers/{cheerId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null
            && request.resource.data.userId == request.auth.uid
            && request.resource.data.emoji is string
            && request.resource.data.emoji.size() <= 10;
          allow delete: if request.auth != null && request.auth.token.role == 'admin';
        }
      }

      // Users - readable by admins, own doc readable by self
      match /users/{uniqueCode} {
        allow read: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          request.auth.token.uniqueCode == uniqueCode
        );
        allow write: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Votes - created exclusively through API (Admin SDK bypasses rules)
      match /votes/{voteId} {
        allow read: if request.auth != null;
        allow create, update, delete: if false;
      }

      // Chat rooms - metadata managed by admins
      match /chatRooms/{roomId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.token.role == 'admin';

        // Chat messages - immutable once created; soft delete via admin API
        match /messages/{messageId} {
          allow read: if request.auth != null && (
            roomId == 'global' ||
            request.auth.token.teamId == roomId ||
            request.auth.token.role == 'admin'
          );
          allow create: if request.auth != null
            && (
              roomId == 'global' ||
              request.auth.token.teamId == roomId ||
              request.auth.token.role == 'admin'
            )
            && request.resource.data.text is string
            && request.resource.data.text.size() >= 1
            && request.resource.data.text.size() <= 500
            && request.resource.data.senderId == request.auth.uid
            && request.resource.data.deleted == false;
          allow update: if false;
          allow delete: if request.auth != null && request.auth.token.role == 'admin';
        }
      }

      // Announcements - readable by auth, writable by admin
      match /announcements/{announcementId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Per-user read state for chat rooms
      match /users/{uniqueCode}/roomState/{roomId} {
        allow read: if request.auth != null && request.auth.token.uniqueCode == uniqueCode;
        allow write: if request.auth != null && request.auth.token.uniqueCode == uniqueCode;
      }

      // User missions
      match /users/{uniqueCode}/missions/{missionId} {
        allow read: if request.auth != null && (
          request.auth.token.uniqueCode == uniqueCode ||
          request.auth.token.role == 'admin'
        );
        allow write: if request.auth != null && (
          request.auth.token.uniqueCode == uniqueCode ||
          request.auth.token.role == 'admin'
        );
      }

      // Team feedbacks
      match /teams/{teamId}/feedbacks/{feedbackId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
          && request.resource.data.text is string
          && request.resource.data.text.size() >= 1
          && request.resource.data.text.size() <= 200;
        allow update: if request.auth != null && (
          request.auth.token.teamId == teamId ||
          request.auth.token.role == 'admin'
        );
        allow delete: if request.auth != null && request.auth.token.role == 'admin';
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
