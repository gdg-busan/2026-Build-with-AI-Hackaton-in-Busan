rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Event config - readable by authenticated users, writable by admins only
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin';

      // Teams - readable by authenticated, writable by admins
      match /teams/{teamId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Users - readable by admins, own doc readable by self
      match /users/{uniqueCode} {
        allow read: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          request.auth.token.uniqueCode == uniqueCode
        );
        allow write: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Votes - 1 person 1 vote enforced by document ID matching voter UID
      match /votes/{voterId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
          && request.auth.uid == voterId
          && !exists(/databases/$(database)/documents/events/$(eventId)/votes/$(voterId));
        allow update, delete: if false;
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
